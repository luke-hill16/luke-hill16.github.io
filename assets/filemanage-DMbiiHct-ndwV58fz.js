import{l as e,n as l,S as a,m as t,Z as i,s as o,z as n,I as u,P as s,q as d,X as r,j as p,c,o as v,b as m,U as f,M as h}from"./index-BEF7uh_8.js";const y={style:{"margin-bottom":"16px",color:"#888"}},_={key:0,style:{"text-align":"center",color:"#aaa","margin-top":"40px"}},g={style:{width:"100px",height:"100px",margin:"0 auto 16px",background:"#f5f5f5","border-radius":"8px",display:"flex","align-items":"center","justify-content":"center"}},x={key:0},w={key:1},b=["src"],k=["src"],C=["src"],z={key:3,style:{"max-height":"400px",overflow:"auto"}},W={key:4},V={__name:"filemanage",setup(V){const M=e(),j=l(),A=a([]),B=a(!1),U=a(""),E=a(""),I=a(""),$=a(""),F=a(""),K=a(!1),L=a(""),O=a(!1),S=a(""),T={Authorization:"JWT "+localStorage.getItem("OA_TOKEN_KEY")},q=async()=>{try{if(!M.is_logined)return m.error("请先登录"),void j.push("/login");const{data:e}=await v.get("/api/auth/files/",{headers:T});A.value=Array.isArray(e)?e:[]}catch(e){A.value=[],m.error("获取文件列表失败")}},J=t((()=>(A.value.reduce(((e,l)=>e+(l.size||0)),0)/1048576).toFixed(2))),N=e=>M.is_logined?["image/png","image/jpeg","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(e.type)?!(e.size>10485760&&(S.value="文件不能超过10MB",O.value=!0,1)):(S.value="不支持的文件类型",O.value=!0,!1):(m.error("请先登录"),j.push("/login"),!1),P=(e,l)=>{S.value="上传成功",O.value=!0,q()},R=(e,l)=>{S.value="上传失败",O.value=!0},Y=t((()=>"application/pdf"===$.value||F.value&&F.value.toLowerCase().endsWith(".pdf"))),Z=t((()=>{const e=F.value.toLowerCase();return e.endsWith(".doc")||e.endsWith(".docx")||e.endsWith(".xls")||e.endsWith(".xlsx")||e.endsWith(".ppt")||e.endsWith(".pptx")})),D=t((()=>`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(U.value)}`)),G=t((()=>U.value));return i(q),(e,l)=>{const a=o("el-button"),t=o("el-upload"),i=o("el-table-column"),V=o("el-table"),M=o("Folder"),j=o("el-icon"),q=o("el-card"),H=o("el-dialog");return n(),u("div",null,[l[13]||(l[13]=s("h2",{style:{"margin-bottom":"10px"}},"文件管理",-1)),s("div",y,[l[3]||(l[3]=d(" 当前共 ")),s("b",null,r(A.value.length),1),l[4]||(l[4]=d(" 个文件，已用存储 ")),s("b",null,r(J.value)+" MB",1)]),p(t,{class:"upload-demo",action:"/api/auth/files/upload/",name:"file",headers:T,"show-file-list":!1,"before-upload":N,"on-success":P,"on-error":R,style:{"margin-bottom":"20px"}},{default:c((()=>[p(a,{type:"primary"},{default:c((()=>l[5]||(l[5]=[d("上传文件")]))),_:1,__:[5]}),l[6]||(l[6]=s("span",{style:{"margin-left":"12px",color:"#aaa"}},"支持图片、文档、文本等类型，单文件不超过10MB",-1))])),_:1,__:[6]}),p(V,{data:A.value,style:{width:"100%","margin-bottom":"20px"}},{default:c((()=>[p(i,{prop:"original_name",label:"文件名"}),p(i,{prop:"upload_time",label:"上传时间"}),p(i,{prop:"uploader_name",label:"上传者"}),p(i,{prop:"size_display",label:"大小",width:"100"}),p(i,{prop:"file_type_display",label:"类型",width:"80"}),p(i,{label:"操作",width:"220"},{default:c((e=>[p(a,{size:"small",onClick:l=>(async e=>{B.value=!0,K.value=!0,L.value="",U.value="",E.value="",I.value="",$.value="",F.value="";try{const{data:l}=await v.get(`/api/auth/files/${e.id}/preview/`,{headers:T});if(I.value=l.file_type,$.value=l.mime_type||"",F.value=l.name||"","image"===l.file_type)U.value=l.preview_url;else if("text"===l.file_type){const e=await v.get(l.preview_url);E.value=e.data}else"document"!==l.file_type&&"other"!==l.file_type||(U.value=l.preview_url)}catch(l){L.value="预览失败"}finally{K.value=!1}})(e.row)},{default:c((()=>l[7]||(l[7]=[d("预览")]))),_:2,__:[7]},1032,["onClick"]),p(a,{size:"small",type:"success",onClick:l=>(async e=>{try{const{data:l}=await v.get(`/api/auth/files/${e.id}/download/`,{headers:T}),a=document.createElement("a");a.href=l.download_url,a.download=l.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a),m.success("开始下载文件")}catch(l){m.error("下载失败")}})(e.row)},{default:c((()=>l[8]||(l[8]=[d("下载")]))),_:2,__:[8]},1032,["onClick"])])),_:1})])),_:1},8,["data"]),0===A.value.length?(n(),u("div",_,[s("div",g,[p(j,{style:{"font-size":"40px",color:"#ddd"}},{default:c((()=>[p(M)])),_:1})]),l[9]||(l[9]=s("div",null,"暂无文件，快来上传你的第一个文件吧！",-1))])):f("",!0),p(q,{style:{"margin-top":"32px"}},{header:c((()=>l[10]||(l[10]=[s("span",null,"操作说明",-1)]))),default:c((()=>[l[11]||(l[11]=s("ul",null,[s("li",null,"点击“上传文件”按钮选择并上传文件。"),s("li",null,"支持图片、文档、文本等常见类型，单文件最大10MB。"),s("li",null,"上传后可在列表中预览、下载文件。"),s("li",null,"如遇上传失败，请检查网络或文件类型/大小。")],-1))])),_:1,__:[11]}),p(H,{modelValue:B.value,"onUpdate:modelValue":l[0]||(l[0]=e=>B.value=e),title:"文件预览",width:"60%"},{default:c((()=>[K.value?(n(),u("div",x,"加载中...")):L.value?(n(),u("div",w,r(L.value),1)):(n(),u(h,{key:2},["image"===I.value?(n(),u("img",{key:0,src:U.value,style:{"max-width":"100%","max-height":"60vh"}},null,8,b)):Y.value?(n(),u("iframe",{key:1,src:G.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,k)):Z.value?(n(),u("iframe",{key:2,src:D.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,C)):"text"===I.value?(n(),u("pre",z,r(E.value),1)):(n(),u("div",W,"该文件类型暂不支持预览"))],64))])),_:1},8,["modelValue"]),p(H,{modelValue:O.value,"onUpdate:modelValue":l[2]||(l[2]=e=>O.value=e),title:"上传结果",width:"30%"},{footer:c((()=>[p(a,{type:"primary",onClick:l[1]||(l[1]=e=>O.value=!1)},{default:c((()=>l[12]||(l[12]=[d("确定")]))),_:1,__:[12]})])),default:c((()=>[s("div",null,r(S.value),1)])),_:1},8,["modelValue"])])}}};export{V as default};
