import{w as $}from"./axios-DWwaMX5J-DXTQ3iZI-BeByrt0G.js";import{X,L as n,R as _,E as q,$ as u,M as t,a as f,l as g,Y as a,J as o,P as H,d as Q,C as w,r,b as d,D as Z}from"./index-q8LaeBoo.js";const ee={style:{"margin-bottom":"16px",color:"#888"}},le={key:0,style:{"text-align":"center",color:"#aaa","margin-top":"40px"}},ae={style:{width:"100px",height:"100px",margin:"0 auto 16px",background:"#f5f5f5","border-radius":"8px",display:"flex","align-items":"center","justify-content":"center"}},te={key:0},oe={key:1},ie=["src"],ne=["src"],ue=["src"],de={key:3,style:{"max-height":"400px",overflow:"auto"}},re={key:4},ve={__name:"filemanage",setup(se){const V=X(),A=Q(),c=n([]),C=n(!1),v=n(""),W=n(""),x=n(""),z=n(""),h=n(""),M=n(!1),b=n(""),s=n(!1),y=n(""),k={Authorization:"JWT "+localStorage.getItem("OA_TOKEN_KEY")},B=async()=>{try{if(!V.is_logined){w.error("请先登录"),A.push("/login");return}const{data:l}=await $.get("/api/auth/files/",{headers:k});c.value=Array.isArray(l)?l:[]}catch{c.value=[],w.error("获取文件列表失败")}},L=_(()=>(c.value.reduce((l,e)=>l+(e.size||0),0)/(1024*1024)).toFixed(2)),U=l=>V.is_logined?["image/png","image/jpeg","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(l.type)?l.size>10*1024*1024?(y.value="文件不能超过10MB",s.value=!0,!1):!0:(y.value="不支持的文件类型",s.value=!0,!1):(w.error("请先登录"),A.push("/login"),!1),j=(l,e)=>{y.value="上传成功",s.value=!0,B()},D=(l,e)=>{y.value="上传失败",s.value=!0},F=async l=>{console.log("handlePreview 被调用",l),C.value=!0,M.value=!0,b.value="",v.value="",W.value="",x.value="",z.value="",h.value="";try{const{data:e}=await $.get(`/api/auth/files/${l.id}/preview/`,{headers:k});if(console.log("预览接口返回:",e),x.value=e.file_type,z.value=e.mime_type||"",h.value=e.name||"",e.file_type==="image")v.value=e.preview_url;else if(e.file_type==="text"){const i=await $.get(e.preview_url);W.value=i.data}else(e.file_type==="document"||e.file_type==="other")&&(v.value=e.preview_url)}catch{b.value="预览失败"}finally{M.value=!1}},I=async l=>{try{const{data:e}=await $.get(`/api/auth/files/${l.id}/download/`,{headers:k}),i=document.createElement("a");i.href=e.download_url,i.download=e.filename,document.body.appendChild(i),i.click(),document.body.removeChild(i),w.success("开始下载文件")}catch{w.error("下载失败")}},J=_(()=>z.value==="application/pdf"||h.value&&h.value.toLowerCase().endsWith(".pdf")),K=_(()=>{const l=h.value.toLowerCase();return l.endsWith(".doc")||l.endsWith(".docx")||l.endsWith(".xls")||l.endsWith(".xlsx")||l.endsWith(".ppt")||l.endsWith(".pptx")}),O=_(()=>`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(v.value)}`),P=_(()=>v.value);return q(B),(l,e)=>{const i=r("el-button"),R=r("el-upload"),m=r("el-table-column"),T=r("el-table"),Y=r("Folder"),G=r("el-icon"),N=r("el-card"),E=r("el-dialog");return d(),u("div",null,[e[13]||(e[13]=t("h2",{style:{"margin-bottom":"10px"}},"文件管理",-1)),t("div",ee,[e[3]||(e[3]=f(" 当前共 ")),t("b",null,g(c.value.length),1),e[4]||(e[4]=f(" 个文件，已用存储 ")),t("b",null,g(L.value)+" MB",1)]),a(R,{class:"upload-demo",action:"/api/auth/files/upload/",name:"file",headers:k,"show-file-list":!1,"before-upload":U,"on-success":j,"on-error":D,style:{"margin-bottom":"20px"}},{default:o(()=>[a(i,{type:"primary"},{default:o(()=>e[5]||(e[5]=[f("上传文件")])),_:1,__:[5]}),e[6]||(e[6]=t("span",{style:{"margin-left":"12px",color:"#aaa"}},"支持图片、文档、文本等类型，单文件不超过10MB",-1))]),_:1,__:[6]}),a(T,{data:c.value,style:{width:"100%","margin-bottom":"20px"}},{default:o(()=>[a(m,{prop:"original_name",label:"文件名"}),a(m,{prop:"upload_time",label:"上传时间"}),a(m,{prop:"uploader_name",label:"上传者"}),a(m,{prop:"size_display",label:"大小",width:"100"}),a(m,{prop:"file_type_display",label:"类型",width:"80"}),a(m,{label:"操作",width:"220"},{default:o(p=>[a(i,{size:"small",onClick:S=>F(p.row)},{default:o(()=>e[7]||(e[7]=[f("预览")])),_:2,__:[7]},1032,["onClick"]),a(i,{size:"small",type:"success",onClick:S=>I(p.row)},{default:o(()=>e[8]||(e[8]=[f("下载")])),_:2,__:[8]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),c.value.length===0?(d(),u("div",le,[t("div",ae,[a(G,{style:{"font-size":"40px",color:"#ddd"}},{default:o(()=>[a(Y)]),_:1})]),e[9]||(e[9]=t("div",null,"暂无文件，快来上传你的第一个文件吧！",-1))])):H("",!0),a(N,{style:{"margin-top":"32px"}},{header:o(()=>e[10]||(e[10]=[t("span",null,"操作说明",-1)])),default:o(()=>[e[11]||(e[11]=t("ul",null,[t("li",null,"点击“上传文件”按钮选择并上传文件。"),t("li",null,"支持图片、文档、文本等常见类型，单文件最大10MB。"),t("li",null,"上传后可在列表中预览、下载文件。"),t("li",null,"如遇上传失败，请检查网络或文件类型/大小。")],-1))]),_:1,__:[11]}),a(E,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=p=>C.value=p),title:"文件预览",width:"60%"},{default:o(()=>[M.value?(d(),u("div",te,"加载中...")):b.value?(d(),u("div",oe,g(b.value),1)):(d(),u(Z,{key:2},[x.value==="image"?(d(),u("img",{key:0,src:v.value,style:{"max-width":"100%","max-height":"60vh"}},null,8,ie)):J.value?(d(),u("iframe",{key:1,src:P.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,ne)):K.value?(d(),u("iframe",{key:2,src:O.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,ue)):x.value==="text"?(d(),u("pre",de,g(W.value),1)):(d(),u("div",re,"该文件类型暂不支持预览"))],64))]),_:1},8,["modelValue"]),a(E,{modelValue:s.value,"onUpdate:modelValue":e[2]||(e[2]=p=>s.value=p),title:"上传结果",width:"30%"},{footer:o(()=>[a(i,{type:"primary",onClick:e[1]||(e[1]=p=>s.value=!1)},{default:o(()=>e[12]||(e[12]=[f("确定")])),_:1,__:[12]})]),default:o(()=>[t("div",null,g(y.value),1)]),_:1},8,["modelValue"])])}}};export{ve as default};
