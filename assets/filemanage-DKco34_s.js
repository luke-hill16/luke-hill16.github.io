import{A as q,r as s,l as g,o as G,c as i,a as o,g as f,t as w,b as l,w as a,j as Q,E as h,B as C,d as u,e as r,F as X,C as Z}from"./index-CKnxlqKw.js";const ee={style:{"margin-bottom":"16px",color:"#888"}},te={key:0,style:{"text-align":"center",color:"#aaa","margin-top":"40px"}},le={style:{width:"100px",height:"100px",margin:"0 auto 16px",background:"#f5f5f5","border-radius":"8px",display:"flex","align-items":"center","justify-content":"center"}},oe={key:0},ae={key:1},ne=["src"],se=["src"],ie=["src"],re={key:3,style:{"max-height":"400px",overflow:"auto"}},ue={key:4},ce={__name:"filemanage",setup(de){const z=q(),E=Z(),c=s([]),V=s(!1),v=s(""),B=s(""),x=s(""),M=s(""),_=s(""),U=s(!1),b=s(""),d=s(!1),y=s(""),k={Authorization:"JWT "+localStorage.getItem("OA_TOKEN_KEY")},W=async()=>{try{if(!z.is_logined){h.error("请先登录"),E.push("/login");return}const{data:t}=await C.get("/api/auth/files/",{headers:k});c.value=Array.isArray(t)?t:[]}catch{c.value=[],h.error("获取文件列表失败")}},F=g(()=>(c.value.reduce((t,e)=>t+(e.size||0),0)/(1024*1024)).toFixed(2)),N=t=>z.is_logined?["image/png","image/jpeg","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(t.type)?t.size>10*1024*1024?(y.value="文件不能超过10MB",d.value=!0,!1):!0:(y.value="不支持的文件类型",d.value=!0,!1):(h.error("请先登录"),E.push("/login"),!1),S=(t,e)=>{y.value="上传成功",d.value=!0,W()},T=(t,e)=>{y.value="上传失败",d.value=!0},$=async t=>{console.log("handlePreview 被调用",t),V.value=!0,U.value=!0,b.value="",v.value="",B.value="",x.value="",M.value="",_.value="";try{const{data:e}=await C.get(`/api/auth/files/${t.id}/preview/`,{headers:k});if(console.log("预览接口返回:",e),x.value=e.file_type,M.value=e.mime_type||"",_.value=e.name||"",e.file_type==="image")v.value=e.preview_url;else if(e.file_type==="text"){const n=await C.get(e.preview_url);B.value=n.data}else(e.file_type==="document"||e.file_type==="other")&&(v.value=e.preview_url)}catch{b.value="预览失败"}finally{U.value=!1}},R=async t=>{try{const{data:e}=await C.get(`/api/auth/files/${t.id}/download/`,{headers:k}),n=document.createElement("a");n.href=e.download_url,n.download=e.filename,document.body.appendChild(n),n.click(),document.body.removeChild(n),h.success("开始下载文件")}catch{h.error("下载失败")}},L=g(()=>M.value==="application/pdf"||_.value&&_.value.toLowerCase().endsWith(".pdf")),j=g(()=>{const t=_.value.toLowerCase();return t.endsWith(".doc")||t.endsWith(".docx")||t.endsWith(".xls")||t.endsWith(".xlsx")||t.endsWith(".ppt")||t.endsWith(".pptx")}),O=g(()=>`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(v.value)}`),P=g(()=>v.value);return G(W),(t,e)=>{const n=u("el-button"),D=u("el-upload"),m=u("el-table-column"),I=u("el-table"),K=u("Folder"),H=u("el-icon"),J=u("el-card"),A=u("el-dialog");return r(),i("div",null,[e[13]||(e[13]=o("h2",{style:{"margin-bottom":"10px"}},"文件管理",-1)),o("div",ee,[e[3]||(e[3]=f(" 当前共 ")),o("b",null,w(c.value.length),1),e[4]||(e[4]=f(" 个文件，已用存储 ")),o("b",null,w(F.value)+" MB",1)]),l(D,{class:"upload-demo",action:"/api/auth/files/upload/",name:"file",headers:k,"show-file-list":!1,"before-upload":N,"on-success":S,"on-error":T,style:{"margin-bottom":"20px"}},{default:a(()=>[l(n,{type:"primary"},{default:a(()=>e[5]||(e[5]=[f("上传文件")])),_:1,__:[5]}),e[6]||(e[6]=o("span",{style:{"margin-left":"12px",color:"#aaa"}},"支持图片、文档、文本等类型，单文件不超过10MB",-1))]),_:1,__:[6]}),l(I,{data:c.value,style:{width:"100%","margin-bottom":"20px"}},{default:a(()=>[l(m,{prop:"original_name",label:"文件名"}),l(m,{prop:"upload_time",label:"上传时间"}),l(m,{prop:"uploader_name",label:"上传者"}),l(m,{prop:"size_display",label:"大小",width:"100"}),l(m,{prop:"file_type_display",label:"类型",width:"80"}),l(m,{label:"操作",width:"220"},{default:a(p=>[l(n,{size:"small",onClick:Y=>$(p.row)},{default:a(()=>e[7]||(e[7]=[f("预览")])),_:2,__:[7]},1032,["onClick"]),l(n,{size:"small",type:"success",onClick:Y=>R(p.row)},{default:a(()=>e[8]||(e[8]=[f("下载")])),_:2,__:[8]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),c.value.length===0?(r(),i("div",te,[o("div",le,[l(H,{style:{"font-size":"40px",color:"#ddd"}},{default:a(()=>[l(K)]),_:1})]),e[9]||(e[9]=o("div",null,"暂无文件，快来上传你的第一个文件吧！",-1))])):Q("",!0),l(J,{style:{"margin-top":"32px"}},{header:a(()=>e[10]||(e[10]=[o("span",null,"操作说明",-1)])),default:a(()=>[e[11]||(e[11]=o("ul",null,[o("li",null,"点击“上传文件”按钮选择并上传文件。"),o("li",null,"支持图片、文档、文本等常见类型，单文件最大10MB。"),o("li",null,"上传后可在列表中预览、下载文件。"),o("li",null,"如遇上传失败，请检查网络或文件类型/大小。")],-1))]),_:1,__:[11]}),l(A,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=p=>V.value=p),title:"文件预览",width:"60%"},{default:a(()=>[U.value?(r(),i("div",oe,"加载中...")):b.value?(r(),i("div",ae,w(b.value),1)):(r(),i(X,{key:2},[x.value==="image"?(r(),i("img",{key:0,src:v.value,style:{"max-width":"100%","max-height":"60vh"}},null,8,ne)):L.value?(r(),i("iframe",{key:1,src:P.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,se)):j.value?(r(),i("iframe",{key:2,src:O.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,ie)):x.value==="text"?(r(),i("pre",re,w(B.value),1)):(r(),i("div",ue,"该文件类型暂不支持预览"))],64))]),_:1},8,["modelValue"]),l(A,{modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=p=>d.value=p),title:"上传结果",width:"30%"},{footer:a(()=>[l(n,{type:"primary",onClick:e[1]||(e[1]=p=>d.value=!1)},{default:a(()=>e[12]||(e[12]=[f("确定")])),_:1,__:[12]})]),default:a(()=>[o("div",null,w(y.value),1)]),_:1},8,["modelValue"])])}}};export{ce as default};
