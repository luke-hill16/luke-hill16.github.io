import{ref as e,computed as l,onMounted as a,resolveComponent as t,openBlock as i,createElementBlock as o,createElementVNode as u,createTextVNode as n,toDisplayString as r,createVNode as d,withCtx as p,createCommentVNode as s,Fragment as v}from"vue";import{ElMessage as c}from"element-plus";import{a as m}from"./axios-DjXdQO6G.js";import{u as f,a as h}from"./index-BOpLbFaH.js";const y={style:{"margin-bottom":"16px",color:"#888"}},_={key:0,style:{"text-align":"center",color:"#aaa","margin-top":"40px"}},g={style:{width:"100px",height:"100px",margin:"0 auto 16px",background:"#f5f5f5","border-radius":"8px",display:"flex","align-items":"center","justify-content":"center"}},x={key:0},w={key:1},b=["src"],k=["src"],C=["src"],W={key:3,style:{"max-height":"400px",overflow:"auto"}},z={key:4},V={__name:"filemanage",setup(V){const j=f(),A=h(),B=e([]),M=e(!1),E=e(""),U=e(""),$=e(""),F=e(""),I=e(""),K=e(!1),L=e(""),O=e(!1),T=e(""),J={Authorization:"JWT "+localStorage.getItem("OA_TOKEN_KEY")},N=async()=>{try{if(!j.is_logined)return c.error("请先登录"),void A.push("/login");const{data:e}=await m.get("/api/auth/files/",{headers:J});B.value=Array.isArray(e)?e:[]}catch(e){B.value=[],c.error("获取文件列表失败")}},R=l((()=>(B.value.reduce(((e,l)=>e+(l.size||0)),0)/1048576).toFixed(2))),S=e=>{if(!j.is_logined)return c.error("请先登录"),A.push("/login"),!1;return["image/png","image/jpeg","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(e.type)?!(e.size>10485760)||(T.value="文件不能超过10MB",O.value=!0,!1):(T.value="不支持的文件类型",O.value=!0,!1)},Y=(e,l)=>{T.value="上传成功",O.value=!0,N()},q=(e,l)=>{T.value="上传失败",O.value=!0},D=l((()=>"application/pdf"===F.value||I.value&&I.value.toLowerCase().endsWith(".pdf"))),G=l((()=>{const e=I.value.toLowerCase();return e.endsWith(".doc")||e.endsWith(".docx")||e.endsWith(".xls")||e.endsWith(".xlsx")||e.endsWith(".ppt")||e.endsWith(".pptx")})),H=l((()=>`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(E.value)}`)),P=l((()=>E.value));return a(N),(e,l)=>{const a=t("el-button"),f=t("el-upload"),h=t("el-table-column"),V=t("el-table"),j=t("Folder"),A=t("el-icon"),N=t("el-card"),Q=t("el-dialog");return i(),o("div",null,[l[13]||(l[13]=u("h2",{style:{"margin-bottom":"10px"}},"文件管理",-1)),u("div",y,[l[3]||(l[3]=n(" 当前共 ")),u("b",null,r(B.value.length),1),l[4]||(l[4]=n(" 个文件，已用存储 ")),u("b",null,r(R.value)+" MB",1)]),d(f,{class:"upload-demo",action:"/api/auth/files/upload/",name:"file",headers:J,"show-file-list":!1,"before-upload":S,"on-success":Y,"on-error":q,style:{"margin-bottom":"20px"}},{default:p((()=>[d(a,{type:"primary"},{default:p((()=>l[5]||(l[5]=[n("上传文件")]))),_:1,__:[5]}),l[6]||(l[6]=u("span",{style:{"margin-left":"12px",color:"#aaa"}},"支持图片、文档、文本等类型，单文件不超过10MB",-1))])),_:1,__:[6]}),d(V,{data:B.value,style:{width:"100%","margin-bottom":"20px"}},{default:p((()=>[d(h,{prop:"original_name",label:"文件名"}),d(h,{prop:"upload_time",label:"上传时间"}),d(h,{prop:"uploader_name",label:"上传者"}),d(h,{prop:"size_display",label:"大小",width:"100"}),d(h,{prop:"file_type_display",label:"类型",width:"80"}),d(h,{label:"操作",width:"220"},{default:p((e=>[d(a,{size:"small",onClick:l=>(async e=>{M.value=!0,K.value=!0,L.value="",E.value="",U.value="",$.value="",F.value="",I.value="";try{const{data:l}=await m.get(`/api/auth/files/${e.id}/preview/`,{headers:J});if($.value=l.file_type,F.value=l.mime_type||"",I.value=l.name||"","image"===l.file_type)E.value=l.preview_url;else if("text"===l.file_type){const e=await m.get(l.preview_url);U.value=e.data}else"document"!==l.file_type&&"other"!==l.file_type||(E.value=l.preview_url)}catch(l){L.value="预览失败"}finally{K.value=!1}})(e.row)},{default:p((()=>l[7]||(l[7]=[n("预览")]))),_:2,__:[7]},1032,["onClick"]),d(a,{size:"small",type:"success",onClick:l=>(async e=>{try{const{data:l}=await m.get(`/api/auth/files/${e.id}/download/`,{headers:J}),a=document.createElement("a");a.href=l.download_url,a.download=l.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a),c.success("开始下载文件")}catch(l){c.error("下载失败")}})(e.row)},{default:p((()=>l[8]||(l[8]=[n("下载")]))),_:2,__:[8]},1032,["onClick"])])),_:1})])),_:1},8,["data"]),0===B.value.length?(i(),o("div",_,[u("div",g,[d(A,{style:{"font-size":"40px",color:"#ddd"}},{default:p((()=>[d(j)])),_:1})]),l[9]||(l[9]=u("div",null,"暂无文件，快来上传你的第一个文件吧！",-1))])):s("",!0),d(N,{style:{"margin-top":"32px"}},{header:p((()=>l[10]||(l[10]=[u("span",null,"操作说明",-1)]))),default:p((()=>[l[11]||(l[11]=u("ul",null,[u("li",null,"点击“上传文件”按钮选择并上传文件。"),u("li",null,"支持图片、文档、文本等常见类型，单文件最大10MB。"),u("li",null,"上传后可在列表中预览、下载文件。"),u("li",null,"如遇上传失败，请检查网络或文件类型/大小。")],-1))])),_:1,__:[11]}),d(Q,{modelValue:M.value,"onUpdate:modelValue":l[0]||(l[0]=e=>M.value=e),title:"文件预览",width:"60%"},{default:p((()=>[K.value?(i(),o("div",x,"加载中...")):L.value?(i(),o("div",w,r(L.value),1)):(i(),o(v,{key:2},["image"===$.value?(i(),o("img",{key:0,src:E.value,style:{"max-width":"100%","max-height":"60vh"}},null,8,b)):D.value?(i(),o("iframe",{key:1,src:P.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,k)):G.value?(i(),o("iframe",{key:2,src:H.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,C)):"text"===$.value?(i(),o("pre",W,r(U.value),1)):(i(),o("div",z,"该文件类型暂不支持预览"))],64))])),_:1},8,["modelValue"]),d(Q,{modelValue:O.value,"onUpdate:modelValue":l[2]||(l[2]=e=>O.value=e),title:"上传结果",width:"30%"},{footer:p((()=>[d(a,{type:"primary",onClick:l[1]||(l[1]=e=>O.value=!1)},{default:p((()=>l[12]||(l[12]=[n("确定")]))),_:1,__:[12]})])),default:p((()=>[u("div",null,r(T.value),1)])),_:1},8,["modelValue"])])}}};export{V as default};
