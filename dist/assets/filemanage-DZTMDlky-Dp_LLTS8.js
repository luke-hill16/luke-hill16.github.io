import{S as C}from"./axios-DWwaMX5J-DXTQ3iZI.js";import{V as H,Y as n,R as _,K as Q,p as u,a as t,e as f,o as g,C as a,c as i,Q as q,M as X,J as x,r,I as s,T as Z}from"./index-DNlctori.js";const ee={style:{"margin-bottom":"16px",color:"#888"}},le={key:0,style:{"text-align":"center",color:"#aaa","margin-top":"40px"}},ae={style:{width:"100px",height:"100px",margin:"0 auto 16px",background:"#f5f5f5","border-radius":"8px",display:"flex","align-items":"center","justify-content":"center"}},te={key:0},ie={key:1},oe=["src"],ne=["src"],ue=["src"],se={key:3,style:{"max-height":"400px",overflow:"auto"}},re={key:4},ve={__name:"filemanage",setup(de){const I=H(),T=X(),c=n([]),z=n(!1),v=n(""),W=n(""),w=n(""),V=n(""),h=n(""),M=n(!1),b=n(""),d=n(!1),y=n(""),k={Authorization:"JWT "+localStorage.getItem("OA_TOKEN_KEY")},$=async()=>{try{if(!I.is_logined){x.error("请先登录"),T.push("/login");return}const{data:l}=await C.get("/api/auth/files/",{headers:k});c.value=Array.isArray(l)?l:[]}catch{c.value=[],x.error("获取文件列表失败")}},B=_(()=>(c.value.reduce((l,e)=>l+(e.size||0),0)/(1024*1024)).toFixed(2)),Y=l=>I.is_logined?["image/png","image/jpeg","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(l.type)?l.size>10*1024*1024?(y.value="文件不能超过10MB",d.value=!0,!1):!0:(y.value="不支持的文件类型",d.value=!0,!1):(x.error("请先登录"),T.push("/login"),!1),E=(l,e)=>{y.value="上传成功",d.value=!0,$()},K=(l,e)=>{y.value="上传失败",d.value=!0},U=async l=>{console.log("handlePreview 被调用",l),z.value=!0,M.value=!0,b.value="",v.value="",W.value="",w.value="",V.value="",h.value="";try{const{data:e}=await C.get(`/api/auth/files/${l.id}/preview/`,{headers:k});if(console.log("预览接口返回:",e),w.value=e.file_type,V.value=e.mime_type||"",h.value=e.name||"",e.file_type==="image")v.value=e.preview_url;else if(e.file_type==="text"){const o=await C.get(e.preview_url);W.value=o.data}else(e.file_type==="document"||e.file_type==="other")&&(v.value=e.preview_url)}catch{b.value="预览失败"}finally{M.value=!1}},j=async l=>{try{const{data:e}=await C.get(`/api/auth/files/${l.id}/download/`,{headers:k}),o=document.createElement("a");o.href=e.download_url,o.download=e.filename,document.body.appendChild(o),o.click(),document.body.removeChild(o),x.success("开始下载文件")}catch{x.error("下载失败")}},F=_(()=>V.value==="application/pdf"||h.value&&h.value.toLowerCase().endsWith(".pdf")),J=_(()=>{const l=h.value.toLowerCase();return l.endsWith(".doc")||l.endsWith(".docx")||l.endsWith(".xls")||l.endsWith(".xlsx")||l.endsWith(".ppt")||l.endsWith(".pptx")}),L=_(()=>`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(v.value)}`),O=_(()=>v.value);return Q($),(l,e)=>{const o=r("el-button"),R=r("el-upload"),m=r("el-table-column"),S=r("el-table"),D=r("Folder"),N=r("el-icon"),P=r("el-card"),A=r("el-dialog");return s(),u("div",null,[e[13]||(e[13]=t("h2",{style:{"margin-bottom":"10px"}},"文件管理",-1)),t("div",ee,[e[3]||(e[3]=f(" 当前共 ")),t("b",null,g(c.value.length),1),e[4]||(e[4]=f(" 个文件，已用存储 ")),t("b",null,g(B.value)+" MB",1)]),a(R,{class:"upload-demo",action:"/api/auth/files/upload/",name:"file",headers:k,"show-file-list":!1,"before-upload":Y,"on-success":E,"on-error":K,style:{"margin-bottom":"20px"}},{default:i(()=>[a(o,{type:"primary"},{default:i(()=>e[5]||(e[5]=[f("上传文件")])),_:1,__:[5]}),e[6]||(e[6]=t("span",{style:{"margin-left":"12px",color:"#aaa"}},"支持图片、文档、文本等类型，单文件不超过10MB",-1))]),_:1,__:[6]}),a(S,{data:c.value,style:{width:"100%","margin-bottom":"20px"}},{default:i(()=>[a(m,{prop:"original_name",label:"文件名"}),a(m,{prop:"upload_time",label:"上传时间"}),a(m,{prop:"uploader_name",label:"上传者"}),a(m,{prop:"size_display",label:"大小",width:"100"}),a(m,{prop:"file_type_display",label:"类型",width:"80"}),a(m,{label:"操作",width:"220"},{default:i(p=>[a(o,{size:"small",onClick:G=>U(p.row)},{default:i(()=>e[7]||(e[7]=[f("预览")])),_:2,__:[7]},1032,["onClick"]),a(o,{size:"small",type:"success",onClick:G=>j(p.row)},{default:i(()=>e[8]||(e[8]=[f("下载")])),_:2,__:[8]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),c.value.length===0?(s(),u("div",le,[t("div",ae,[a(N,{style:{"font-size":"40px",color:"#ddd"}},{default:i(()=>[a(D)]),_:1})]),e[9]||(e[9]=t("div",null,"暂无文件，快来上传你的第一个文件吧！",-1))])):q("",!0),a(P,{style:{"margin-top":"32px"}},{header:i(()=>e[10]||(e[10]=[t("span",null,"操作说明",-1)])),default:i(()=>[e[11]||(e[11]=t("ul",null,[t("li",null,"点击“上传文件”按钮选择并上传文件。"),t("li",null,"支持图片、文档、文本等常见类型，单文件最大10MB。"),t("li",null,"上传后可在列表中预览、下载文件。"),t("li",null,"如遇上传失败，请检查网络或文件类型/大小。")],-1))]),_:1,__:[11]}),a(A,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=p=>z.value=p),title:"文件预览",width:"60%"},{default:i(()=>[M.value?(s(),u("div",te,"加载中...")):b.value?(s(),u("div",ie,g(b.value),1)):(s(),u(Z,{key:2},[w.value==="image"?(s(),u("img",{key:0,src:v.value,style:{"max-width":"100%","max-height":"60vh"}},null,8,oe)):F.value?(s(),u("iframe",{key:1,src:O.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,ne)):J.value?(s(),u("iframe",{key:2,src:L.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,ue)):w.value==="text"?(s(),u("pre",se,g(W.value),1)):(s(),u("div",re,"该文件类型暂不支持预览"))],64))]),_:1},8,["modelValue"]),a(A,{modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=p=>d.value=p),title:"上传结果",width:"30%"},{footer:i(()=>[a(o,{type:"primary",onClick:e[1]||(e[1]=p=>d.value=!1)},{default:i(()=>e[12]||(e[12]=[f("确定")])),_:1,__:[12]})]),default:i(()=>[t("div",null,g(y.value),1)]),_:1},8,["modelValue"])])}}};export{ve as default};
