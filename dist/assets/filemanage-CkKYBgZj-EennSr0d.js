import{v as q,r as G,V as n,S as _,o as Q,B as s,w as u,M as d,k as t,j as f,a as g,b as a,W as i,d as X,z as Z,e as w,s as $}from"./index-BVmt8t0O.js";const ee={style:{"margin-bottom":"16px",color:"#888"}},le={key:0,style:{"text-align":"center",color:"#aaa","margin-top":"40px"}},ae={style:{width:"100px",height:"100px",margin:"0 auto 16px",background:"#f5f5f5","border-radius":"8px",display:"flex","align-items":"center","justify-content":"center"}},te={key:0},ie={key:1},oe=["src"],ne=["src"],ue=["src"],de={key:3,style:{"max-height":"400px",overflow:"auto"}},se={key:4},ce={__name:"filemanage",setup(re){const V=q(),M=G(),c=n([]),z=n(!1),v=n(""),C=n(""),x=n(""),W=n(""),h=n(""),B=n(!1),b=n(""),r=n(!1),y=n(""),k={Authorization:"JWT "+localStorage.getItem("OA_TOKEN_KEY")},j=async()=>{try{if(!V.is_logined){w.error("请先登录"),M.push("/login");return}const{data:l}=await $.get("/api/auth/files/",{headers:k});c.value=Array.isArray(l)?l:[]}catch{c.value=[],w.error("获取文件列表失败")}},E=_(()=>(c.value.reduce((l,e)=>l+(e.size||0),0)/(1024*1024)).toFixed(2)),U=l=>V.is_logined?["image/png","image/jpeg","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(l.type)?l.size>10*1024*1024?(y.value="文件不能超过10MB",r.value=!0,!1):!0:(y.value="不支持的文件类型",r.value=!0,!1):(w.error("请先登录"),M.push("/login"),!1),F=(l,e)=>{y.value="上传成功",r.value=!0,j()},I=(l,e)=>{y.value="上传失败",r.value=!0},K=async l=>{console.log("handlePreview 被调用",l),z.value=!0,B.value=!0,b.value="",v.value="",C.value="",x.value="",W.value="",h.value="";try{const{data:e}=await $.get(`/api/auth/files/${l.id}/preview/`,{headers:k});if(console.log("预览接口返回:",e),x.value=e.file_type,W.value=e.mime_type||"",h.value=e.name||"",e.file_type==="image")v.value=e.preview_url;else if(e.file_type==="text"){const o=await $.get(e.preview_url);C.value=o.data}else(e.file_type==="document"||e.file_type==="other")&&(v.value=e.preview_url)}catch{b.value="预览失败"}finally{B.value=!1}},L=async l=>{try{const{data:e}=await $.get(`/api/auth/files/${l.id}/download/`,{headers:k}),o=document.createElement("a");o.href=e.download_url,o.download=e.filename,document.body.appendChild(o),o.click(),document.body.removeChild(o),w.success("开始下载文件")}catch{w.error("下载失败")}},O=_(()=>W.value==="application/pdf"||h.value&&h.value.toLowerCase().endsWith(".pdf")),S=_(()=>{const l=h.value.toLowerCase();return l.endsWith(".doc")||l.endsWith(".docx")||l.endsWith(".xls")||l.endsWith(".xlsx")||l.endsWith(".ppt")||l.endsWith(".pptx")}),T=_(()=>`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(v.value)}`),Y=_(()=>v.value);return Q(j),(l,e)=>{const o=s("el-button"),J=s("el-upload"),m=s("el-table-column"),N=s("el-table"),P=s("Folder"),R=s("el-icon"),D=s("el-card"),A=s("el-dialog");return u(),d("div",null,[e[13]||(e[13]=t("h2",{style:{"margin-bottom":"10px"}},"文件管理",-1)),t("div",ee,[e[3]||(e[3]=f(" 当前共 ")),t("b",null,g(c.value.length),1),e[4]||(e[4]=f(" 个文件，已用存储 ")),t("b",null,g(E.value)+" MB",1)]),a(J,{class:"upload-demo",action:"/api/auth/files/upload/",name:"file",headers:k,"show-file-list":!1,"before-upload":U,"on-success":F,"on-error":I,style:{"margin-bottom":"20px"}},{default:i(()=>[a(o,{type:"primary"},{default:i(()=>e[5]||(e[5]=[f("上传文件")])),_:1,__:[5]}),e[6]||(e[6]=t("span",{style:{"margin-left":"12px",color:"#aaa"}},"支持图片、文档、文本等类型，单文件不超过10MB",-1))]),_:1,__:[6]}),a(N,{data:c.value,style:{width:"100%","margin-bottom":"20px"}},{default:i(()=>[a(m,{prop:"original_name",label:"文件名"}),a(m,{prop:"upload_time",label:"上传时间"}),a(m,{prop:"uploader_name",label:"上传者"}),a(m,{prop:"size_display",label:"大小",width:"100"}),a(m,{prop:"file_type_display",label:"类型",width:"80"}),a(m,{label:"操作",width:"220"},{default:i(p=>[a(o,{size:"small",onClick:H=>K(p.row)},{default:i(()=>e[7]||(e[7]=[f("预览")])),_:2,__:[7]},1032,["onClick"]),a(o,{size:"small",type:"success",onClick:H=>L(p.row)},{default:i(()=>e[8]||(e[8]=[f("下载")])),_:2,__:[8]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),c.value.length===0?(u(),d("div",le,[t("div",ae,[a(R,{style:{"font-size":"40px",color:"#ddd"}},{default:i(()=>[a(P)]),_:1})]),e[9]||(e[9]=t("div",null,"暂无文件，快来上传你的第一个文件吧！",-1))])):X("",!0),a(D,{style:{"margin-top":"32px"}},{header:i(()=>e[10]||(e[10]=[t("span",null,"操作说明",-1)])),default:i(()=>[e[11]||(e[11]=t("ul",null,[t("li",null,"点击“上传文件”按钮选择并上传文件。"),t("li",null,"支持图片、文档、文本等常见类型，单文件最大10MB。"),t("li",null,"上传后可在列表中预览、下载文件。"),t("li",null,"如遇上传失败，请检查网络或文件类型/大小。")],-1))]),_:1,__:[11]}),a(A,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=p=>z.value=p),title:"文件预览",width:"60%"},{default:i(()=>[B.value?(u(),d("div",te,"加载中...")):b.value?(u(),d("div",ie,g(b.value),1)):(u(),d(Z,{key:2},[x.value==="image"?(u(),d("img",{key:0,src:v.value,style:{"max-width":"100%","max-height":"60vh"}},null,8,oe)):O.value?(u(),d("iframe",{key:1,src:Y.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,ne)):S.value?(u(),d("iframe",{key:2,src:T.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,ue)):x.value==="text"?(u(),d("pre",de,g(C.value),1)):(u(),d("div",se,"该文件类型暂不支持预览"))],64))]),_:1},8,["modelValue"]),a(A,{modelValue:r.value,"onUpdate:modelValue":e[2]||(e[2]=p=>r.value=p),title:"上传结果",width:"30%"},{footer:i(()=>[a(o,{type:"primary",onClick:e[1]||(e[1]=p=>r.value=!1)},{default:i(()=>e[12]||(e[12]=[f("确定")])),_:1,__:[12]})]),default:i(()=>[t("div",null,g(y.value),1)]),_:1},8,["modelValue"])])}}};export{ce as default};
