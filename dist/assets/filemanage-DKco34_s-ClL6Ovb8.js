import{n as e,p as l,V as a,S as t,o as i,B as o,b as n,M as u,k as d,e as s,a as r,c as p,W as c,f as v,z as m,J as f,q as h}from"./index-DyjvvSaJ.js";const y={style:{"margin-bottom":"16px",color:"#888"}},_={key:0,style:{"text-align":"center",color:"#aaa","margin-top":"40px"}},g={style:{width:"100px",height:"100px",margin:"0 auto 16px",background:"#f5f5f5","border-radius":"8px",display:"flex","align-items":"center","justify-content":"center"}},x={key:0},w={key:1},b=["src"],k=["src"],C=["src"],z={key:3,style:{"max-height":"400px",overflow:"auto"}},W={key:4},V={__name:"filemanage",setup(V){const B=e(),A=l(),M=a([]),j=a(!1),E=a(""),U=a(""),$=a(""),F=a(""),I=a(""),J=a(!1),K=a(""),L=a(!1),O=a(""),T={Authorization:"JWT "+localStorage.getItem("OA_TOKEN_KEY")},q=async()=>{try{if(!B.is_logined)return f.error("请先登录"),void A.push("/login");const{data:e}=await h.get("/api/auth/files/",{headers:T});M.value=Array.isArray(e)?e:[]}catch{M.value=[],f.error("获取文件列表失败")}},N=t((()=>(M.value.reduce(((e,l)=>e+(l.size||0)),0)/1048576).toFixed(2))),R=e=>B.is_logined?["image/png","image/jpeg","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(e.type)?!(e.size>10485760)||(O.value="文件不能超过10MB",L.value=!0,!1):(O.value="不支持的文件类型",L.value=!0,!1):(f.error("请先登录"),A.push("/login"),!1),S=(e,l)=>{O.value="上传成功",L.value=!0,q()},Y=(e,l)=>{O.value="上传失败",L.value=!0},D=t((()=>"application/pdf"===F.value||I.value&&I.value.toLowerCase().endsWith(".pdf"))),G=t((()=>{const e=I.value.toLowerCase();return e.endsWith(".doc")||e.endsWith(".docx")||e.endsWith(".xls")||e.endsWith(".xlsx")||e.endsWith(".ppt")||e.endsWith(".pptx")})),H=t((()=>`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(E.value)}`)),P=t((()=>E.value));return i(q),(e,l)=>{const a=o("el-button"),t=o("el-upload"),i=o("el-table-column"),V=o("el-table"),B=o("Folder"),A=o("el-icon"),q=o("el-card"),Q=o("el-dialog");return n(),u("div",null,[l[13]||(l[13]=d("h2",{style:{"margin-bottom":"10px"}},"文件管理",-1)),d("div",y,[l[3]||(l[3]=s(" 当前共 ")),d("b",null,r(M.value.length),1),l[4]||(l[4]=s(" 个文件，已用存储 ")),d("b",null,r(N.value)+" MB",1)]),p(t,{class:"upload-demo",action:"/api/auth/files/upload/",name:"file",headers:T,"show-file-list":!1,"before-upload":R,"on-success":S,"on-error":Y,style:{"margin-bottom":"20px"}},{default:c((()=>[p(a,{type:"primary"},{default:c((()=>l[5]||(l[5]=[s("上传文件")]))),_:1,__:[5]}),l[6]||(l[6]=d("span",{style:{"margin-left":"12px",color:"#aaa"}},"支持图片、文档、文本等类型，单文件不超过10MB",-1))])),_:1,__:[6]}),p(V,{data:M.value,style:{width:"100%","margin-bottom":"20px"}},{default:c((()=>[p(i,{prop:"original_name",label:"文件名"}),p(i,{prop:"upload_time",label:"上传时间"}),p(i,{prop:"uploader_name",label:"上传者"}),p(i,{prop:"size_display",label:"大小",width:"100"}),p(i,{prop:"file_type_display",label:"类型",width:"80"}),p(i,{label:"操作",width:"220"},{default:c((e=>[p(a,{size:"small",onClick:l=>(async e=>{j.value=!0,J.value=!0,K.value="",E.value="",U.value="",$.value="",F.value="",I.value="";try{const{data:l}=await h.get(`/api/auth/files/${e.id}/preview/`,{headers:T});if($.value=l.file_type,F.value=l.mime_type||"",I.value=l.name||"","image"===l.file_type)E.value=l.preview_url;else if("text"===l.file_type){const e=await h.get(l.preview_url);U.value=e.data}else("document"===l.file_type||"other"===l.file_type)&&(E.value=l.preview_url)}catch{K.value="预览失败"}finally{J.value=!1}})(e.row)},{default:c((()=>l[7]||(l[7]=[s("预览")]))),_:2,__:[7]},1032,["onClick"]),p(a,{size:"small",type:"success",onClick:l=>(async e=>{try{const{data:l}=await h.get(`/api/auth/files/${e.id}/download/`,{headers:T}),a=document.createElement("a");a.href=l.download_url,a.download=l.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a),f.success("开始下载文件")}catch{f.error("下载失败")}})(e.row)},{default:c((()=>l[8]||(l[8]=[s("下载")]))),_:2,__:[8]},1032,["onClick"])])),_:1})])),_:1},8,["data"]),0===M.value.length?(n(),u("div",_,[d("div",g,[p(A,{style:{"font-size":"40px",color:"#ddd"}},{default:c((()=>[p(B)])),_:1})]),l[9]||(l[9]=d("div",null,"暂无文件，快来上传你的第一个文件吧！",-1))])):v("",!0),p(q,{style:{"margin-top":"32px"}},{header:c((()=>l[10]||(l[10]=[d("span",null,"操作说明",-1)]))),default:c((()=>[l[11]||(l[11]=d("ul",null,[d("li",null,"点击“上传文件”按钮选择并上传文件。"),d("li",null,"支持图片、文档、文本等常见类型，单文件最大10MB。"),d("li",null,"上传后可在列表中预览、下载文件。"),d("li",null,"如遇上传失败，请检查网络或文件类型/大小。")],-1))])),_:1,__:[11]}),p(Q,{modelValue:j.value,"onUpdate:modelValue":l[0]||(l[0]=e=>j.value=e),title:"文件预览",width:"60%"},{default:c((()=>[J.value?(n(),u("div",x,"加载中...")):K.value?(n(),u("div",w,r(K.value),1)):(n(),u(m,{key:2},["image"===$.value?(n(),u("img",{key:0,src:E.value,style:{"max-width":"100%","max-height":"60vh"}},null,8,b)):D.value?(n(),u("iframe",{key:1,src:P.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,k)):G.value?(n(),u("iframe",{key:2,src:H.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,C)):"text"===$.value?(n(),u("pre",z,r(U.value),1)):(n(),u("div",W,"该文件类型暂不支持预览"))],64))])),_:1},8,["modelValue"]),p(Q,{modelValue:L.value,"onUpdate:modelValue":l[2]||(l[2]=e=>L.value=e),title:"上传结果",width:"30%"},{footer:c((()=>[p(a,{type:"primary",onClick:l[1]||(l[1]=e=>L.value=!1)},{default:c((()=>l[12]||(l[12]=[s("确定")]))),_:1,__:[12]})])),default:c((()=>[d("div",null,r(O.value),1)])),_:1},8,["modelValue"])])}}};export{V as default};
