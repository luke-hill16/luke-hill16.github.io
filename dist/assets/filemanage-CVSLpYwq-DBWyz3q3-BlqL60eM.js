import{m as q,j as G,B as n,S as _,o as Q,a as r,b as u,O as d,_ as t,H as f,k as g,$ as a,K as i,d as X,c as Z,J as w,n as C}from"./index-2YECzvFn.js";const ee={style:{"margin-bottom":"16px",color:"#888"}},le={key:0,style:{"text-align":"center",color:"#aaa","margin-top":"40px"}},ae={style:{width:"100px",height:"100px",margin:"0 auto 16px",background:"#f5f5f5","border-radius":"8px",display:"flex","align-items":"center","justify-content":"center"}},te={key:0},ie={key:1},oe=["src"],ne=["src"],ue=["src"],de={key:3,style:{"max-height":"400px",overflow:"auto"}},re={key:4},ce={__name:"filemanage",setup(se){const V=q(),A=G(),c=n([]),$=n(!1),v=n(""),W=n(""),x=n(""),z=n(""),h=n(""),B=n(!1),b=n(""),s=n(!1),y=n(""),k={Authorization:"JWT "+localStorage.getItem("OA_TOKEN_KEY")},M=async()=>{try{if(!V.is_logined){w.error("请先登录"),A.push("/login");return}const{data:l}=await C.get("/api/auth/files/",{headers:k});c.value=Array.isArray(l)?l:[]}catch{c.value=[],w.error("获取文件列表失败")}},E=_(()=>(c.value.reduce((l,e)=>l+(e.size||0),0)/(1024*1024)).toFixed(2)),H=l=>V.is_logined?["image/png","image/jpeg","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(l.type)?l.size>10*1024*1024?(y.value="文件不能超过10MB",s.value=!0,!1):!0:(y.value="不支持的文件类型",s.value=!0,!1):(w.error("请先登录"),A.push("/login"),!1),J=(l,e)=>{y.value="上传成功",s.value=!0,M()},K=(l,e)=>{y.value="上传失败",s.value=!0},O=async l=>{console.log("handlePreview 被调用",l),$.value=!0,B.value=!0,b.value="",v.value="",W.value="",x.value="",z.value="",h.value="";try{const{data:e}=await C.get(`/api/auth/files/${l.id}/preview/`,{headers:k});if(console.log("预览接口返回:",e),x.value=e.file_type,z.value=e.mime_type||"",h.value=e.name||"",e.file_type==="image")v.value=e.preview_url;else if(e.file_type==="text"){const o=await C.get(e.preview_url);W.value=o.data}else(e.file_type==="document"||e.file_type==="other")&&(v.value=e.preview_url)}catch{b.value="预览失败"}finally{B.value=!1}},U=async l=>{try{const{data:e}=await C.get(`/api/auth/files/${l.id}/download/`,{headers:k}),o=document.createElement("a");o.href=e.download_url,o.download=e.filename,document.body.appendChild(o),o.click(),document.body.removeChild(o),w.success("开始下载文件")}catch{w.error("下载失败")}},F=_(()=>z.value==="application/pdf"||h.value&&h.value.toLowerCase().endsWith(".pdf")),I=_(()=>{const l=h.value.toLowerCase();return l.endsWith(".doc")||l.endsWith(".docx")||l.endsWith(".xls")||l.endsWith(".xlsx")||l.endsWith(".ppt")||l.endsWith(".pptx")}),L=_(()=>`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(v.value)}`),S=_(()=>v.value);return Q(M),(l,e)=>{const o=r("el-button"),T=r("el-upload"),m=r("el-table-column"),N=r("el-table"),P=r("Folder"),R=r("el-icon"),Y=r("el-card"),j=r("el-dialog");return u(),d("div",null,[e[13]||(e[13]=t("h2",{style:{"margin-bottom":"10px"}},"文件管理",-1)),t("div",ee,[e[3]||(e[3]=f(" 当前共 ")),t("b",null,g(c.value.length),1),e[4]||(e[4]=f(" 个文件，已用存储 ")),t("b",null,g(E.value)+" MB",1)]),a(T,{class:"upload-demo",action:"/api/auth/files/upload/",name:"file",headers:k,"show-file-list":!1,"before-upload":H,"on-success":J,"on-error":K,style:{"margin-bottom":"20px"}},{default:i(()=>[a(o,{type:"primary"},{default:i(()=>e[5]||(e[5]=[f("上传文件")])),_:1,__:[5]}),e[6]||(e[6]=t("span",{style:{"margin-left":"12px",color:"#aaa"}},"支持图片、文档、文本等类型，单文件不超过10MB",-1))]),_:1,__:[6]}),a(N,{data:c.value,style:{width:"100%","margin-bottom":"20px"}},{default:i(()=>[a(m,{prop:"original_name",label:"文件名"}),a(m,{prop:"upload_time",label:"上传时间"}),a(m,{prop:"uploader_name",label:"上传者"}),a(m,{prop:"size_display",label:"大小",width:"100"}),a(m,{prop:"file_type_display",label:"类型",width:"80"}),a(m,{label:"操作",width:"220"},{default:i(p=>[a(o,{size:"small",onClick:D=>O(p.row)},{default:i(()=>e[7]||(e[7]=[f("预览")])),_:2,__:[7]},1032,["onClick"]),a(o,{size:"small",type:"success",onClick:D=>U(p.row)},{default:i(()=>e[8]||(e[8]=[f("下载")])),_:2,__:[8]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),c.value.length===0?(u(),d("div",le,[t("div",ae,[a(R,{style:{"font-size":"40px",color:"#ddd"}},{default:i(()=>[a(P)]),_:1})]),e[9]||(e[9]=t("div",null,"暂无文件，快来上传你的第一个文件吧！",-1))])):X("",!0),a(Y,{style:{"margin-top":"32px"}},{header:i(()=>e[10]||(e[10]=[t("span",null,"操作说明",-1)])),default:i(()=>[e[11]||(e[11]=t("ul",null,[t("li",null,"点击“上传文件”按钮选择并上传文件。"),t("li",null,"支持图片、文档、文本等常见类型，单文件最大10MB。"),t("li",null,"上传后可在列表中预览、下载文件。"),t("li",null,"如遇上传失败，请检查网络或文件类型/大小。")],-1))]),_:1,__:[11]}),a(j,{modelValue:$.value,"onUpdate:modelValue":e[0]||(e[0]=p=>$.value=p),title:"文件预览",width:"60%"},{default:i(()=>[B.value?(u(),d("div",te,"加载中...")):b.value?(u(),d("div",ie,g(b.value),1)):(u(),d(Z,{key:2},[x.value==="image"?(u(),d("img",{key:0,src:v.value,style:{"max-width":"100%","max-height":"60vh"}},null,8,oe)):F.value?(u(),d("iframe",{key:1,src:S.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,ne)):I.value?(u(),d("iframe",{key:2,src:L.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,ue)):x.value==="text"?(u(),d("pre",de,g(W.value),1)):(u(),d("div",re,"该文件类型暂不支持预览"))],64))]),_:1},8,["modelValue"]),a(j,{modelValue:s.value,"onUpdate:modelValue":e[2]||(e[2]=p=>s.value=p),title:"上传结果",width:"30%"},{footer:i(()=>[a(o,{type:"primary",onClick:e[1]||(e[1]=p=>s.value=!1)},{default:i(()=>e[12]||(e[12]=[f("确定")])),_:1,__:[12]})]),default:i(()=>[t("div",null,g(y.value),1)]),_:1},8,["modelValue"])])}}};export{ce as default};
