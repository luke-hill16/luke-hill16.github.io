import{A as e,r as l,l as a,o as t,c as i,a as o,g as n,t as u,b as s,w as d,j as r,E as p,B as c,d as v,e as m,F as f,C as h}from"./index-C3v4GxiK.js";const y={style:{"margin-bottom":"16px",color:"#888"}},_={key:0,style:{"text-align":"center",color:"#aaa","margin-top":"40px"}},g={style:{width:"100px",height:"100px",margin:"0 auto 16px",background:"#f5f5f5","border-radius":"8px",display:"flex","align-items":"center","justify-content":"center"}},x={key:0},w={key:1},b=["src"],k=["src"],C=["src"],W={key:3,style:{"max-height":"400px",overflow:"auto"}},z={key:4},V={__name:"filemanage",setup(V){const A=e(),B=h(),j=l([]),E=l(!1),M=l(""),F=l(""),U=l(""),$=l(""),I=l(""),K=l(!1),L=l(""),O=l(!1),T=l(""),J={Authorization:"JWT "+localStorage.getItem("OA_TOKEN_KEY")},N=async()=>{try{if(!A.is_logined)return p.error("请先登录"),void B.push("/login");const{data:e}=await c.get("/api/auth/files/",{headers:J});j.value=Array.isArray(e)?e:[]}catch(e){j.value=[],p.error("获取文件列表失败")}},R=a((()=>(j.value.reduce(((e,l)=>e+(l.size||0)),0)/1048576).toFixed(2))),S=e=>{if(!A.is_logined)return p.error("请先登录"),B.push("/login"),!1;return["image/png","image/jpeg","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(e.type)?!(e.size>10485760)||(T.value="文件不能超过10MB",O.value=!0,!1):(T.value="不支持的文件类型",O.value=!0,!1)},Y=(e,l)=>{T.value="上传成功",O.value=!0,N()},q=(e,l)=>{T.value="上传失败",O.value=!0},D=a((()=>"application/pdf"===$.value||I.value&&I.value.toLowerCase().endsWith(".pdf"))),G=a((()=>{const e=I.value.toLowerCase();return e.endsWith(".doc")||e.endsWith(".docx")||e.endsWith(".xls")||e.endsWith(".xlsx")||e.endsWith(".ppt")||e.endsWith(".pptx")})),H=a((()=>`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(M.value)}`)),P=a((()=>M.value));return t(N),(e,l)=>{const a=v("el-button"),t=v("el-upload"),h=v("el-table-column"),V=v("el-table"),A=v("Folder"),B=v("el-icon"),N=v("el-card"),Q=v("el-dialog");return m(),i("div",null,[l[13]||(l[13]=o("h2",{style:{"margin-bottom":"10px"}},"文件管理",-1)),o("div",y,[l[3]||(l[3]=n(" 当前共 ")),o("b",null,u(j.value.length),1),l[4]||(l[4]=n(" 个文件，已用存储 ")),o("b",null,u(R.value)+" MB",1)]),s(t,{class:"upload-demo",action:"/api/auth/files/upload/",name:"file",headers:J,"show-file-list":!1,"before-upload":S,"on-success":Y,"on-error":q,style:{"margin-bottom":"20px"}},{default:d((()=>[s(a,{type:"primary"},{default:d((()=>l[5]||(l[5]=[n("上传文件")]))),_:1,__:[5]}),l[6]||(l[6]=o("span",{style:{"margin-left":"12px",color:"#aaa"}},"支持图片、文档、文本等类型，单文件不超过10MB",-1))])),_:1,__:[6]}),s(V,{data:j.value,style:{width:"100%","margin-bottom":"20px"}},{default:d((()=>[s(h,{prop:"original_name",label:"文件名"}),s(h,{prop:"upload_time",label:"上传时间"}),s(h,{prop:"uploader_name",label:"上传者"}),s(h,{prop:"size_display",label:"大小",width:"100"}),s(h,{prop:"file_type_display",label:"类型",width:"80"}),s(h,{label:"操作",width:"220"},{default:d((e=>[s(a,{size:"small",onClick:l=>(async e=>{E.value=!0,K.value=!0,L.value="",M.value="",F.value="",U.value="",$.value="",I.value="";try{const{data:l}=await c.get(`/api/auth/files/${e.id}/preview/`,{headers:J});if(U.value=l.file_type,$.value=l.mime_type||"",I.value=l.name||"","image"===l.file_type)M.value=l.preview_url;else if("text"===l.file_type){const e=await c.get(l.preview_url);F.value=e.data}else"document"!==l.file_type&&"other"!==l.file_type||(M.value=l.preview_url)}catch(l){L.value="预览失败"}finally{K.value=!1}})(e.row)},{default:d((()=>l[7]||(l[7]=[n("预览")]))),_:2,__:[7]},1032,["onClick"]),s(a,{size:"small",type:"success",onClick:l=>(async e=>{try{const{data:l}=await c.get(`/api/auth/files/${e.id}/download/`,{headers:J}),a=document.createElement("a");a.href=l.download_url,a.download=l.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a),p.success("开始下载文件")}catch(l){p.error("下载失败")}})(e.row)},{default:d((()=>l[8]||(l[8]=[n("下载")]))),_:2,__:[8]},1032,["onClick"])])),_:1})])),_:1},8,["data"]),0===j.value.length?(m(),i("div",_,[o("div",g,[s(B,{style:{"font-size":"40px",color:"#ddd"}},{default:d((()=>[s(A)])),_:1})]),l[9]||(l[9]=o("div",null,"暂无文件，快来上传你的第一个文件吧！",-1))])):r("",!0),s(N,{style:{"margin-top":"32px"}},{header:d((()=>l[10]||(l[10]=[o("span",null,"操作说明",-1)]))),default:d((()=>[l[11]||(l[11]=o("ul",null,[o("li",null,"点击“上传文件”按钮选择并上传文件。"),o("li",null,"支持图片、文档、文本等常见类型，单文件最大10MB。"),o("li",null,"上传后可在列表中预览、下载文件。"),o("li",null,"如遇上传失败，请检查网络或文件类型/大小。")],-1))])),_:1,__:[11]}),s(Q,{modelValue:E.value,"onUpdate:modelValue":l[0]||(l[0]=e=>E.value=e),title:"文件预览",width:"60%"},{default:d((()=>[K.value?(m(),i("div",x,"加载中...")):L.value?(m(),i("div",w,u(L.value),1)):(m(),i(f,{key:2},["image"===U.value?(m(),i("img",{key:0,src:M.value,style:{"max-width":"100%","max-height":"60vh"}},null,8,b)):D.value?(m(),i("iframe",{key:1,src:P.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,k)):G.value?(m(),i("iframe",{key:2,src:H.value,style:{width:"100%",height:"80vh",border:"none"}},null,8,C)):"text"===U.value?(m(),i("pre",W,u(F.value),1)):(m(),i("div",z,"该文件类型暂不支持预览"))],64))])),_:1},8,["modelValue"]),s(Q,{modelValue:O.value,"onUpdate:modelValue":l[2]||(l[2]=e=>O.value=e),title:"上传结果",width:"30%"},{footer:d((()=>[s(a,{type:"primary",onClick:l[1]||(l[1]=e=>O.value=!1)},{default:d((()=>l[12]||(l[12]=[n("确定")]))),_:1,__:[12]})])),default:d((()=>[o("div",null,u(T.value),1)])),_:1},8,["modelValue"])])}}};export{V as default};
